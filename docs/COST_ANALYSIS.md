# MongoDB Atlas 비용 분석: 실시간 조회 vs Pre-aggregation

## 현재 상황

**Bills 컬렉션:**
- 문서 수: 7,630,368개 (약 763만개)
- 기존 인덱스:
  - `_id_` (기본)
  - `idx_date` ✅ (날짜 기반 조회 최적화)
  - `idx_store_oid` ✅ (가맹점별 조회 최적화)
  - `storeOID_1_froms_1__id_1_date_1` ✅ (복합 인덱스)

## 비용 분석

### MongoDB Atlas Pricing (Serverless Tier 기준)

**Read Processing Units (RPU):**
- 1 RPU = 4 KB 읽기
- 가격: $0.10 per million RPUs

**Storage:**
- $0.25 per GB/month

**Backup:**
- $0.20 per GB/month

---

## 시나리오 1: 실시간 집계 (현재 방식)

### 쿼리 패턴 분석

**7일 조회 (인덱스 사용):**
```javascript
// 필터: date >= "2024-01-15" AND date <= "2024-01-21"
// 인덱스 스캔: idx_date
// 예상 문서 수: ~50,000 (일일 7,000건 가정)
```

**예상 읽기량:**
- 인덱스 스캔: ~50,000 documents
- 평균 문서 크기: ~1 KB
- Lookup (stores): 추가 ~2,000 documents (unique stores)
- **총 읽기: ~52 KB → 13 RPUs**

**30일 조회:**
- 예상 문서: ~210,000
- stores lookup: ~2,000
- **총 읽기: ~212 KB → 53 RPUs**

**90일 조회:**
- 예상 문서: ~630,000
- stores lookup: ~2,000
- **총 읽기: ~632 KB → 158 RPUs**

### 캐싱 효과

**캐시 설정:**
- TTL: 5분 (300초)
- 캐시 히트율: 80% 가정

**일일 요청 패턴:**
```
총 요청: 1,000회/일
캐시 히트: 800회 (MongoDB 호출 없음)
캐시 미스: 200회 (MongoDB 호출)
```

### 일일 비용 계산

#### 소규모 (일일 1,000 요청)

**7일 조회 (가장 일반적):**
- 캐시 미스 200회 × 13 RPUs = 2,600 RPUs
- 비용: $0.00026/일 = **$0.008/월**

**30일 조회:**
- 캐시 미스 200회 × 53 RPUs = 10,600 RPUs
- 비용: $0.00106/일 = **$0.032/월**

**90일 조회:**
- 캐시 미스 200회 × 158 RPUs = 31,600 RPUs
- 비용: $0.00316/일 = **$0.095/월**

#### 중규모 (일일 10,000 요청)

**7일 조회:**
- 캐시 미스 2,000회 × 13 RPUs = 26,000 RPUs
- 비용: $0.0026/일 = **$0.08/월**

**30일 조회:**
- 캐시 미스 2,000회 × 53 RPUs = 106,000 RPUs
- 비용: $0.0106/일 = **$0.32/월**

**90일 조회:**
- 캐시 미스 2,000회 × 158 RPUs = 316,000 RPUs
- 비용: $0.0316/일 = **$0.95/월**

#### 대규모 (일일 100,000 요청)

**7일 조회:**
- 캐시 미스 20,000회 × 13 RPUs = 260,000 RPUs
- 비용: $0.026/일 = **$0.78/월**

**30일 조회:**
- 캐시 미스 20,000회 × 53 RPUs = 1,060,000 RPUs
- 비용: $0.106/일 = **$3.18/월**

**90일 조회:**
- 캐시 미스 20,000회 × 158 RPUs = 3,160,000 RPUs
- 비용: $0.316/일 = **$9.48/월**

---

## 시나리오 2: Pre-aggregation (배치 집계)

### 스토리지 비용

**metrics_daily_store:**
- 일일 2,000 stores × 365일 = 730,000 documents
- 문서 크기: ~200 bytes
- 총 크기: 146 MB

**metrics_daily_store_menu:**
- 일일 50,000 unique menu combinations × 365일 = 18,250,000 documents
- 문서 크기: ~300 bytes
- 총 크기: 5.5 GB

**metrics_hourly_store:**
- 2,000 stores × 24 hours × 365일 = 17,520,000 documents
- 문서 크기: ~150 bytes
- 총 크기: 2.6 GB

**총 스토리지: ~8.2 GB**

### 비용

**스토리지:**
- 8.2 GB × $0.25 = **$2.05/월**

**백업:**
- 8.2 GB × $0.20 = **$1.64/월**

**배치 집계 (일일):**
- 7일 재집계: ~50,000 documents 처리
- Write RPUs: ~50,000 × 1 KB / 4 KB = 12,500 WPUs
- 비용: $0.10 per million = **$0.001/일 = $0.03/월**

**읽기 (조회):**
- metrics 컬렉션에서 읽기 (매우 빠름)
- 7일: ~14 documents (2 stores × 7 days)
- 비용: 거의 무료 (~$0.001/월)

**총 비용: $2.05 + $1.64 + $0.03 + $0.001 = $3.72/월**

---

## 비교 요약

| 방식 | 일일 요청 1,000 | 일일 요청 10,000 | 일일 요청 100,000 | 스토리지 |
|------|----------------|-----------------|------------------|---------|
| **실시간 (7일)** | $0.008/월 | $0.08/월 | $0.78/월 | $0 |
| **실시간 (30일)** | $0.032/월 | $0.32/월 | $3.18/월 | $0 |
| **실시간 (90일)** | $0.095/월 | $0.95/월 | $9.48/월 | $0 |
| **Pre-aggregation** | $3.72/월 | $3.72/월 | $3.72/월 | $3.69/월 |

---

## 결론 및 권장사항

### ✅ 실시간 집계가 유리한 경우 (현재 선택)

**조건:**
- 일일 요청 < 10,000회
- 주로 짧은 기간 조회 (7일)
- 캐시 히트율 높음 (>70%)
- 보안 중요 (read-only 권한)

**장점:**
- **비용 매우 저렴** ($0.1/월 미만)
- 실시간 데이터
- 관리 간편
- Write 권한 불필요

**단점:**
- 첫 요청 느림 (1-3초)
- 긴 기간 조회 시 비용 증가

### ⚠️ Pre-aggregation이 유리한 경우

**조건:**
- 일일 요청 > 100,000회
- 긴 기간 조회 빈번 (90일+)
- 캐시 히트율 낮음 (<50%)
- 속도 최우선

**장점:**
- 조회 속도 매우 빠름 (<100ms)
- 고부하에도 일정한 비용
- 긴 기간 조회 가능

**단점:**
- **고정 비용 $3.72/월**
- 스토리지 8.2 GB 필요
- Write 권한 필요
- 배치 관리 필요
- 데이터 지연

---

## 실제 사용 패턴 분석

### 예상 시나리오

**B2B 대시보드 (내부용):**
- 사용자: 5-10명
- 일일 요청: ~500회
- 주 사용: 7일, 30일 조회
- **예상 비용: $0.02/월** ✅

**고객용 대시보드:**
- 사용자: 100-200명
- 일일 요청: ~5,000회
- 주 사용: 7일 조회
- **예상 비용: $0.40/월** ✅

**고부하 서비스:**
- 사용자: 10,000+명
- 일일 요청: 200,000회
- 다양한 기간 조회
- **예상 비용: $15-20/월** → Pre-aggregation 고려 ($3.72/월)

---

## 최적화 전략

### 1. 캐시 TTL 조정

**현재: 5분 (300초)**

더 긴 TTL로 비용 절감:
```env
CACHE_TTL_SECONDS=600  # 10분
# 캐시 히트율: 80% → 90%
# 비용 절감: 50%
```

### 2. 날짜 범위 제한

**현재: 90일**

더 짧은 범위로 제한:
```env
MAX_DATE_RANGE_DAYS=30  # 30일만 허용
# 비용 절감: ~70%
```

### 3. 쿼리 최적화

**필요한 필드만 projection:**
```javascript
.project({
  date: 1,
  gmv: 1,
  orderCount: 1
  // storeName 등 불필요한 lookup 제거
})
```

### 4. Aggregation Pipeline Cache

MongoDB는 자주 사용되는 aggregation을 자동 캐싱합니다:
- 동일한 쿼리 반복 시 서버 캐시 활용
- 추가 비용 없음

---

## 모니터링

### Atlas Metrics 확인

1. Atlas Console → Metrics
2. 확인 항목:
   - **Read Processing Units (RPUs)**
   - **Query Execution Time**
   - **Index Usage**

### 비용 경고 설정

1. Atlas Console → Billing → Alerts
2. 경고 설정:
   - RPUs > 1,000,000/day
   - 월 비용 > $5

---

## 최종 권장사항

### 현재 구성 (실시간 집계) 유지 ✅

**이유:**
1. **비용 매우 저렴** - 예상 $0.1-1/월
2. **보안 우수** - read-only 권한
3. **관리 간편** - 배치 잡 불필요
4. **인덱스 준비됨** - 이미 최적화됨

**모니터링 후 재평가:**
- 월 비용 > $5 발생 시
- 일일 요청 > 100,000회 도달 시
- 조회 속도 불만족 시

→ 그때 Pre-aggregation 전환 고려

---

## 참고 자료

- [MongoDB Atlas Pricing](https://www.mongodb.com/pricing)
- [Serverless Instances](https://www.mongodb.com/docs/atlas/serverless-instance-costs/)
- [Aggregation Performance](https://www.mongodb.com/docs/manual/core/aggregation-pipeline-optimization/)
