# 💰 MongoDB 비용 분석: 실시간 조회 방식

## 결론 먼저

**실시간 조회 방식이 훨씬 저렴합니다!** ✅

- 현재 방식 (실시간): **$0.1~1/월** (일일 요청 10,000회 가정)
- Pre-aggregation: **$3.72/월** (고정 비용)

**인덱스도 이미 준비되어 있습니다!** ✅

---

## 인덱스 확인 결과

Bills 컬렉션에 이미 최적화된 인덱스가 있습니다:

1. `idx_date` - 날짜 기반 조회 최적화 ✅
2. `idx_store_oid` - 가맹점별 조회 최적화 ✅
3. `storeOID_1_froms_1__id_1_date_1` - 복합 인덱스 ✅

→ **추가 작업 불필요**

---

## 비용 비교

### 실시간 조회 (현재 방식)

| 사용량 | 7일 조회 | 30일 조회 | 90일 조회 |
|--------|---------|----------|----------|
| **일일 1,000 요청** | $0.008/월 | $0.032/월 | $0.095/월 |
| **일일 10,000 요청** | $0.08/월 | $0.32/월 | $0.95/월 |
| **일일 100,000 요청** | $0.78/월 | $3.18/월 | $9.48/월 |

**캐시 히트율 80% 가정** (5분 캐싱)

### Pre-aggregation (비교)

**고정 비용: $3.72/월**
- 스토리지: $2.05/월 (8.2 GB)
- 백업: $1.64/월
- 배치 집계: $0.03/월

---

## 실제 예상 비용

### B2B 내부 대시보드 (예상)

**사용 패턴:**
- 사용자: 5-10명
- 일일 요청: ~500회
- 주로 7일, 30일 조회

**월 비용: 약 $0.02** ✅ (거의 무료)

### 고객용 대시보드

**사용 패턴:**
- 사용자: 100-200명
- 일일 요청: ~5,000회
- 주로 7일 조회

**월 비용: 약 $0.40** ✅ (커피 1잔 가격)

---

## 왜 저렴한가?

### 1. 인덱스 최적화

```
인덱스 사용 → 전체 스캔 불필요
7일 조회: 763만개 중 ~5만개만 읽음 (0.7%)
```

### 2. 캐싱 효과

```
5분 캐싱 + 80% 히트율
실제 MongoDB 호출: 20%만
```

### 3. 효율적인 쿼리

```
필요한 필드만 읽음 (Projection)
stores lookup도 unique stores만 (2,000개)
```

---

## 비용 폭탄 방지 전략

### 1. 날짜 범위 제한 (이미 설정됨)

```env
MAX_DATE_RANGE_DAYS=90  # 최대 90일만 조회 가능
```

### 2. 캐싱 (이미 설정됨)

```env
CACHE_TTL_SECONDS=300  # 5분 캐싱
```

### 3. 비용 모니터링

**Atlas Console에서 확인:**
1. Metrics → Read Processing Units (RPUs)
2. Billing → 월별 비용 확인

**경고 설정 권장:**
- RPUs > 1,000,000/day (비정상적으로 높음)
- 월 비용 > $5

---

## 언제 Pre-aggregation으로 전환해야 하나?

### 전환 고려 시점

❌ 지금은 아님 (비용 너무 낮음)

⚠️ 다음 상황 발생 시 고려:
1. **월 비용 > $5 지속**
2. **일일 요청 > 100,000회**
3. **조회 속도 < 1초 필요**

---

## 최적화 팁

### 더 비용을 줄이려면

**1. 캐시 시간 늘리기**
```env
CACHE_TTL_SECONDS=600  # 10분
# 캐시 히트율 80% → 90%
# 비용 50% 절감
```

**2. 날짜 범위 더 줄이기**
```env
MAX_DATE_RANGE_DAYS=30  # 30일로 제한
# 비용 70% 절감
```

**3. 사용 패턴 분석**
- 대부분 7일 조회 → 비용 최소
- 90일 자주 조회 → 비용 증가

---

## 요약

### ✅ 현재 구성 (실시간 조회) 유지

**이유:**
- 💰 **비용 매우 저렴** - 예상 $0.1-1/월
- 🔒 **보안 우수** - read-only 권한만 필요
- 🚀 **관리 간편** - 배치 잡 불필요
- ⚡ **인덱스 준비** - 이미 최적화됨

**모니터링:**
- 월 1회 Atlas Console에서 비용 확인
- 비정상적 증가 시 원인 분석

**전환 시점:**
- 월 비용 > $5 지속 시 재검토

---

## 다음 단계

1. ✅ 인덱스 확인 완료
2. ✅ 비용 분석 완료
3. ⏳ 대시보드 실행 및 테스트
4. ⏳ 1주일 후 실제 비용 확인

---

자세한 비용 분석은 [docs/COST_ANALYSIS.md](docs/COST_ANALYSIS.md)를 참고하세요.
