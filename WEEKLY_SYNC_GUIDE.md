# 증분 데이터 동기화 가이드

## 개요
사용자가 대시보드 하단의 "최신 데이터 가져오기" 버튼을 클릭하면, 비밀번호 인증 후 MongoDB에서 과거 데이터 이후의 새로운 메트릭을 자동으로 수집합니다.

## 특징

### 1. 수동 트리거 방식
- 자동 스케줄러 없음
- 사용자가 필요할 때마다 버튼 클릭으로 데이터 동기화
- UI 내에 통합된 편한 접근성

### 2. 증분 동기화
- 기존 데이터의 최신 날짜 자동 감지
- 그 이후 데이터만 MongoDB에서 조회
- 최초 동기화 시: 과거 30일 데이터 수집

### 3. 간단한 비밀번호 보안
- 기본 비밀번호: `0614`
- 환경 변수로 변경 가능: `DATA_SYNC_PASSWORD`
- 강한 보안 불필요 - 단순 접근 제어용

### 4. 자동 중복 제거
- MongoDB upsert 기반
- storeId + date 조합을 키로 사용
- 기존 데이터 있으면 업데이트, 없으면 신규 삽입

## 아키텍처

### 1. 핵심 모듈

#### `lib/sync/weekly-data-sync.ts` (증분 동기화)
- **getIncrementalSyncDateRange()**: 동기화 날짜 범위 자동 결정
  - 기존 데이터의 최신 날짜 조회
  - 그 다음날부터 현재까지의 범위 계산
  - 초기 상태: 과거 30일로 설정
  
- **fetchIncrementalMetrics()**: 새 데이터만 수집
  - 계산된 날짜 범위에서 미싱 데이터 조회
  - `metrics_daily_store` 컬렉션
  - `metrics_daily_store_menu` 컬렉션

- **mergeMetrics()**: 데이터 병합 및 중복 제거
  - Bulk Write로 대량 작업 최적화
  - upsert로 자동 중복 제거

- **executeIncrementalSync()**: 전체 프로세스 실행

#### `components/DataSyncButton.tsx` (UI 버튼)
- 대시보드 페이지 하단의 "최신 데이터 가져오기" 버튼
- 비밀번호 입력 다이얼로그
- 동기화 결과 표시
- 사용자 피드백 제공

### 2. API Routes

#### `app/api/sync/verify-password/route.ts`
- **POST**: 비밀번호 검증 및 동기화 실행
  - 요청: `{ password: string }`
  - 응답: 동기화 결과

## 사용 방법

### 기본 사용법
1. 대시보드 최하단에서 "최신 데이터 가져오기" 버튼 클릭
2. 비밀번호 입력 다이얼로그 표시
3. 비밀번호 입력 (기본값: `0614`)
4. "동기화" 버튼 클릭
5. 동기화 완료 후 자동으로 다이얼로그 닫힘

### 비밀번호 변경
환경 변수 `.env.local`에 설정:
```env
DATA_SYNC_PASSWORD=your_new_password
```

### 동기화 로그 확인
서버 콘솔에서 다음 로그를 확인할 수 있습니다:
```
[Incremental Sync] Fetching new metrics from ... to ...
[Incremental Sync] Fetched 100 daily metrics and 500 menu metrics
[Incremental Sync] Daily metrics: 50 inserted, 50 updated
[Incremental Sync] Menu metrics: 250 inserted, 250 updated
[Incremental Sync] Incremental data sync completed successfully!
```

## 동기화 로직

### 날짜 범위 결정

```
상황 1: 기존 데이터 있음
────────────────────────
[기존 최신 날짜] → [현재]
    2024-12-10    2024-12-21
    
다음 동기화 범위:
    2024-12-11 ~ 2024-12-21

상황 2: 기존 데이터 없음
────────────────────────
[30일 전]       → [현재]
2024-11-21        2024-12-21

초기 동기화 범위:
2024-11-21 ~ 2024-12-21
```

### 중복 제거 메커니즘

upsert 기반으로 자동 처리:

**일일 메트릭:**
- 필터: `{ storeId, date }`
- 기존 데이터 있으면: 업데이트
- 없으면: 신규 삽입

**메뉴 메트릭:**
- 필터: `{ storeId, menuId, date }`
- 기존 데이터 있으면: 업데이트
- 없으면: 신규 삽입

## UI 상세

### 버튼
- 위치: 대시보드 최하단
- 스타일: outline 버튼
- 아이콘: RefreshCw
- 텍스트: "최신 데이터 가져오기"

### 비밀번호 입력 다이얼로그
- **제목**: "최신 데이터 동기화"
- **설명**: "비밀번호를 입력하여 최신 데이터를 동기화합니다."
- **입력**: 비밀번호 필드 (masked)
- **버튼**: 취소, 동기화

### 동기화 결과 표시

#### 성공
```
✓ 동기화 완료!

동기화 결과
─────────
일일 메트릭: 50개
메뉴 메트릭: 250개

3초 후 자동으로 닫힙니다...
```

#### 실패
```
⚠ 오류
비밀번호가 올바르지 않습니다
[다시 시도] 버튼
```

## 에러 처리

| 에러 | 설명 | 해결 방법 |
|------|------|---------|
| 비밀번호 필수 | 비밀번호를 입력하지 않음 | 비밀번호 입력 후 시도 |
| 비밀번호 불일치 | 잘못된 비밀번호 | 올바른 비밀번호 입력 |
| 동기화 실패 | MongoDB 연결 오류 | 데이터베이스 상태 확인 |

## 성능 고려사항

- **Bulk Write API**: 대량 데이터 삽입/업데이트 최적화
- **Indexed Queries**: storeId, date, menuId에 인덱스 필수
- **초기 동기화**: 30일 데이터는 수초 이내에 완료
- **증분 동기화**: 일반적으로 <100ms

## 보안 참고사항

1. **비밀번호 저장**
   - 평문 저장 (강한 보안 불필요)
   - 프로덕션: 환경 변수로 설정 권장

2. **API 보호**
   - 필요시 API rate limiting 추가 가능
   - IP 화이트리스트 고려

3. **로깅**
   - 모든 동기화 시도 로그 기록됨
   - 실패 이유도 함께 기록

## 타이밍

- **동기화 시간**: 사용자가 버튼 클릭 시
- **완료 시간**: 보통 2-5초
- **자동 닫기**: 성공 후 3초

## 환경 변수

```env
# MongoDB 설정 (기존)
MONGODB_URI=mongodb+srv://...
MONGODB_DB_NAME=taghere

# 데이터 동기화
DATA_SYNC_PASSWORD=0614  # 선택사항, 기본값: 0614
```

## 주의사항

1. **타임존**: KST(Asia/Seoul) 기준으로 자동 처리
2. **초기 상태**: 처음 동기화 시 과거 30일 데이터 수집
3. **중복 키**: storeId + date (menu 메트릭은 menuId도 포함)
4. **무한 동기화**: 범위 초과 시 자동으로 조정됨

## 트러블슈팅

### 비밀번호 계속 오류
```
확인 사항:
- .env.local에서 DATA_SYNC_PASSWORD 값 확인
- 서버 재시작 필요할 수 있음
- 기본 비밀번호: 0614
```

### 데이터가 안 들어옴
```
확인 사항:
- MongoDB 연결 상태
- 동기화 범위 확인
- 서버 콘솔 로그 확인
```

### 동기화가 느림
```
최적화 방법:
- MongoDB 인덱스 확인
- 네트워크 연결 확인
- 데이터 크기 확인
```
